services:
  backend:
    build:
      args:
        TORCH_FLAVOR: ${TORCH_FLAVOR:-cpu}
    command: >
      sh -lc "/app/backend/scripts/bootstrap_gpu_runtime.sh && uvicorn app.main:app --host 0.0.0.0 --port 8000"
    gpus: all
    environment:
      - SEMANTIC_EMBEDDING_BACKEND=${SEMANTIC_EMBEDDING_BACKEND:-clip}
      - CLIP_DEVICE=${CLIP_DEVICE:-cuda}
      - NVIDIA_VISIBLE_DEVICES=${NVIDIA_VISIBLE_DEVICES:-all}
      - NVIDIA_DRIVER_CAPABILITIES=${NVIDIA_DRIVER_CAPABILITIES:-compute,utility}
      - HF_HUB_OFFLINE=${HF_HUB_OFFLINE:-0}
      - TRANSFORMERS_OFFLINE=${TRANSFORMERS_OFFLINE:-0}
